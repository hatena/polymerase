syntax = "proto3";

package storagepb;

service StorageService {
  rpc GetLatestToLSN(GetLatestToLSNRequest) returns (GetLatestToLSNResponse) {};

  rpc GetKeysAtPoint(GetKeysAtPointRequest) returns (GetKeysAtPointResponse) {};

  rpc GetFileByKey(GetFileByKeyRequest) returns (stream FileStream) {};

  rpc PurgePrevBackup(PurgePrevBackupRequest) returns (PurgePrevBackupResponse) {};

  rpc GetBestStartTime(GetBestStartTimeRequest) returns (GetBestStartTimeResponse) {};

  rpc TransferFullBackup(stream FullBackupContentStream) returns (BackupReply) {};

  rpc TransferIncBackup(stream IncBackupContentStream) returns (BackupReply) {};

  rpc PostCheckpoints(PostCheckpointsRequest) returns (PostCheckpointsResponse) {};
}

message GetLatestToLSNRequest {
  string db = 1;
}

message GetLatestToLSNResponse {
  string lsn = 1;
}

message GetKeysAtPointRequest {
  string db = 1;
  string from = 2;
}

message GetKeysAtPointResponse {
  repeated BackupFileInfo keys = 1;
}

message BackupFileInfo {
  string storage_type = 1;
  string backup_type = 2;
  string key = 3;
  int64 size = 4;
}

message GetFileByKeyRequest {
  string key = 1;
  string storage_type = 2;
}

message FileStream {
  bytes content = 1;
}

message PurgePrevBackupRequest {
  string db = 1;
}

message PurgePrevBackupResponse {
  string message = 1;
}

message GetBestStartTimeRequest {

}

message GetBestStartTimeResponse {
  int32 minute = 1;
  int32 hour = 2;
}

message FullBackupContentStream {
  string db = 1;
  bytes content = 2;
}

message IncBackupContentStream {
  string db = 1;
  string lsn = 2;
  bytes content = 3;
}

message BackupReply {
  string message = 1;
  string key = 2;
}

message PostCheckpointsRequest {
  string key = 1;
  bytes content = 2;
}

message PostCheckpointsResponse {
  string message = 1;
}
